<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PptxGenJS Generation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .info {
            color: blue;
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>PptxGenJS Test - Real PowerPoint Generation</h1>
    
    <div class="test-section">
        <h2>Test 1: Basic PowerPoint Generation</h2>
        <p>This test creates a simple PowerPoint file with PptxGenJS to verify it generates real .pptx files.</p>
        <button onclick="testBasicGeneration()">Generate Test PowerPoint</button>
        <div id="basic-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: AI-Style PowerPoint Generation</h2>
        <p>This test simulates the exact same process used by the main app.</p>
        <button onclick="testAIStyleGeneration()">Generate AI-Style PowerPoint</button>
        <div id="ai-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Blob Analysis</h2>
        <p>This test analyzes the generated blob to verify it's a real PowerPoint file.</p>
        <button onclick="testBlobAnalysis()">Analyze Generated Blob</button>
        <div id="blob-result"></div>
    </div>

    <div id="log"></div>

    <!-- PptxGenJS Library -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function testBasicGeneration() {
            const resultDiv = document.getElementById('basic-result');
            resultDiv.innerHTML = '<p class="info">Generating basic PowerPoint...</p>';
            
            try {
                log('Starting basic PowerPoint generation test');
                
                // Check if PptxGenJS is available
                if (typeof PptxGenJS === 'undefined') {
                    throw new Error('PptxGenJS library not loaded');
                }
                log('PptxGenJS library loaded successfully');

                // Create new presentation
                const pptx = new PptxGenJS();
                log('Created new PptxGenJS instance');

                // Set presentation properties
                pptx.author = 'Test Author';
                pptx.company = 'Test Company';
                pptx.title = 'Test Presentation';
                pptx.subject = 'Testing PowerPoint Generation';
                log('Set presentation metadata');

                // Create a simple slide
                const slide = pptx.addSlide();
                slide.addText('Test PowerPoint Generation', {
                    x: 1,
                    y: 1,
                    w: 8,
                    h: 1,
                    fontSize: 32,
                    fontFace: 'Arial',
                    bold: true,
                    color: '0066CC'
                });
                
                slide.addText('This is a test slide generated by PptxGenJS', {
                    x: 1,
                    y: 2.5,
                    w: 8,
                    h: 1,
                    fontSize: 18,
                    fontFace: 'Arial',
                    color: '333333'
                });
                log('Added test slide with content');

                // Generate the PowerPoint file
                log('Generating PowerPoint blob...');
                const pptxBlob = await pptx.write('blob');
                log(`PowerPoint blob generated successfully - Size: ${pptxBlob.size} bytes`);
                log(`Blob type: ${pptxBlob.type}`);

                // Create download
                const filename = `test_basic_${Date.now()}.pptx`;
                const downloadUrl = URL.createObjectURL(pptxBlob);
                
                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Basic PowerPoint generated successfully!</p>
                    <p><strong>File size:</strong> ${formatFileSize(pptxBlob.size)}</p>
                    <p><strong>Blob type:</strong> ${pptxBlob.type || 'application/octet-stream'}</p>
                    <a href="${downloadUrl}" download="${filename}" style="background: #28a745; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px;">
                        üì• Download Test PowerPoint
                    </a>
                `;
                
                log('Basic generation test completed successfully', 'success');
                
            } catch (error) {
                log(`Basic generation test failed: ${error.message}`, 'error');
                resultDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testAIStyleGeneration() {
            const resultDiv = document.getElementById('ai-result');
            resultDiv.innerHTML = '<p class="info">Generating AI-style PowerPoint...</p>';
            
            try {
                log('Starting AI-style PowerPoint generation test');
                
                // Mock AI-generated slide data (similar to what the app generates)
                const mockSlideData = {
                    slides: [
                        {
                            slideNumber: 1,
                            title: "Game Development Sprint Review",
                            content: ["Overview of completed features and performance metrics"],
                            bullets: [],
                            presenterNotes: "Welcome slide for the sprint review presentation",
                            slideType: "title"
                        },
                        {
                            slideNumber: 2,
                            title: "Completed Features",
                            content: [],
                            bullets: [
                                "Player movement system with physics",
                                "Inventory management interface", 
                                "Combat mechanics implementation",
                                "Audio system integration"
                            ],
                            presenterNotes: "Highlight the major features completed in this sprint",
                            slideType: "content"
                        },
                        {
                            slideNumber: 3,
                            title: "Performance Metrics",
                            content: [],
                            bullets: [
                                "Frame rate improved to 60 FPS",
                                "Memory usage reduced by 15%",
                                "Loading times decreased by 30%"
                            ],
                            presenterNotes: "Show the performance improvements achieved",
                            slideType: "content"
                        }
                    ],
                    totalSlides: 3,
                    estimatedDuration: "5 minutes"
                };
                
                log('Created mock AI slide data with 3 slides');

                // Use the same method as the main app
                const pptxBlob = await createPowerPointFromSlideData(mockSlideData);
                log(`AI-style PowerPoint generated - Size: ${pptxBlob.size} bytes`);

                // Create download
                const filename = `test_ai_style_${Date.now()}.pptx`;
                const downloadUrl = URL.createObjectURL(pptxBlob);
                
                resultDiv.innerHTML = `
                    <p class="success">‚úÖ AI-style PowerPoint generated successfully!</p>
                    <p><strong>Slides:</strong> ${mockSlideData.slides.length}</p>
                    <p><strong>File size:</strong> ${formatFileSize(pptxBlob.size)}</p>
                    <p><strong>Blob type:</strong> ${pptxBlob.type || 'application/octet-stream'}</p>
                    <a href="${downloadUrl}" download="${filename}" style="background: #28a745; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px;">
                        üì• Download AI-Style PowerPoint
                    </a>
                `;
                
                log('AI-style generation test completed successfully', 'success');
                
            } catch (error) {
                log(`AI-style generation test failed: ${error.message}`, 'error');
                resultDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        async function testBlobAnalysis() {
            const resultDiv = document.getElementById('blob-result');
            resultDiv.innerHTML = '<p class="info">Analyzing generated blob...</p>';
            
            try {
                log('Starting blob analysis test');
                
                // Generate a test PowerPoint
                const pptx = new PptxGenJS();
                const slide = pptx.addSlide();
                slide.addText('Blob Analysis Test', { x: 1, y: 1, w: 8, h: 1, fontSize: 24 });
                
                const pptxBlob = await pptx.write('blob');
                log(`Generated test blob - Size: ${pptxBlob.size} bytes`);
                
                // Analyze the blob
                const arrayBuffer = await pptxBlob.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // Check for PowerPoint file signatures
                const header = Array.from(uint8Array.slice(0, 8)).map(b => b.toString(16).padStart(2, '0')).join(' ');
                log(`File header (first 8 bytes): ${header}`);
                
                // Check for ZIP signature (PowerPoint files are ZIP archives)
                const isZip = uint8Array[0] === 0x50 && uint8Array[1] === 0x4B;
                log(`ZIP signature detected: ${isZip}`);
                
                // Look for PowerPoint-specific content
                const textDecoder = new TextDecoder('utf-8', { ignoreBOM: true, fatal: false });
                const content = textDecoder.decode(uint8Array);
                const hasPptxContent = content.includes('ppt/') || content.includes('presentation.xml') || content.includes('slide');
                log(`PowerPoint content detected: ${hasPptxContent}`);
                
                // Check MIME type
                log(`Blob MIME type: ${pptxBlob.type || 'not set'}`);
                
                let analysis = '';
                if (isZip && hasPptxContent) {
                    analysis = '‚úÖ This is a valid PowerPoint file (.pptx format)';
                    log('Blob analysis: Valid PowerPoint file detected', 'success');
                } else if (isZip) {
                    analysis = '‚ö†Ô∏è This is a ZIP file but may not be a valid PowerPoint';
                    log('Blob analysis: ZIP file but PowerPoint content unclear', 'error');
                } else {
                    analysis = '‚ùå This does not appear to be a valid PowerPoint file';
                    log('Blob analysis: Not a valid PowerPoint file', 'error');
                }
                
                resultDiv.innerHTML = `
                    <p><strong>Analysis Result:</strong> ${analysis}</p>
                    <p><strong>File size:</strong> ${formatFileSize(pptxBlob.size)}</p>
                    <p><strong>ZIP signature:</strong> ${isZip ? '‚úÖ Present' : '‚ùå Missing'}</p>
                    <p><strong>PowerPoint content:</strong> ${hasPptxContent ? '‚úÖ Detected' : '‚ùå Not found'}</p>
                    <p><strong>MIME type:</strong> ${pptxBlob.type || 'Not set'}</p>
                    <p><strong>File header:</strong> ${header}</p>
                `;
                
            } catch (error) {
                log(`Blob analysis test failed: ${error.message}`, 'error');
                resultDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        }

        // Replicate the exact same PowerPoint creation logic from the main app
        async function createPowerPointFromSlideData(slideData) {
            log('Creating PowerPoint using main app logic...');
            
            // Check if PptxGenJS is available
            if (typeof PptxGenJS === 'undefined') {
                throw new Error('PowerPoint generation library not available');
            }
            
            // Create new presentation
            const pptx = new PptxGenJS();
            
            // Set presentation properties
            pptx.author = 'PowerPoint Generator App';
            pptx.company = 'AI-Powered Presentation Creation';
            pptx.title = slideData.slides[0]?.title || 'Generated Presentation';
            pptx.subject = `${slideData.totalSlides} slides - ${slideData.estimatedDuration}`;
            
            // Set slide dimensions (16:9 aspect ratio)
            pptx.defineLayout({ name: 'LAYOUT_16x9', width: 10, height: 5.625 });
            pptx.layout = 'LAYOUT_16x9';
            
            // Process each slide
            for (let i = 0; i < slideData.slides.length; i++) {
                const slideInfo = slideData.slides[i];
                await createPptxSlide(pptx, slideInfo, i);
                log(`Created slide ${i + 1}: ${slideInfo.title}`);
            }
            
            log(`Generated ${slideData.slides.length} slides`);
            
            // Generate the PowerPoint file
            const pptxBlob = await pptx.write('blob');
            log('PowerPoint file generated successfully');
            
            return pptxBlob;
        }

        // Replicate slide creation logic
        async function createPptxSlide(pptx, slideInfo, slideIndex) {
            // Create new slide
            const slide = pptx.addSlide();
            
            // Determine if this is a title slide
            const isTitleSlide = slideInfo.slideType === 'title' || slideIndex === 0;
            
            if (isTitleSlide) {
                // Title slide layout
                slide.addText(slideInfo.title, {
                    x: 0.5,
                    y: 1.5,
                    w: 9,
                    h: 1.5,
                    fontSize: 32,
                    fontFace: 'Segoe UI',
                    bold: true,
                    color: '0066CC',
                    align: 'center',
                    valign: 'middle'
                });
                
                // Subtitle content (if available)
                if (slideInfo.content && slideInfo.content.length > 0) {
                    const subtitleText = slideInfo.content.join('\n\n');
                    
                    slide.addText(subtitleText, {
                        x: 1,
                        y: 3,
                        w: 8,
                        h: 2,
                        fontSize: 16,
                        fontFace: 'Segoe UI',
                        color: '333333',
                        align: 'center',
                        valign: 'top'
                    });
                }
            } else {
                // Content slide layout
                slide.addText(slideInfo.title, {
                    x: 0.5,
                    y: 0.3,
                    w: 9,
                    h: 0.8,
                    fontSize: 28,
                    fontFace: 'Segoe UI',
                    bold: true,
                    color: '0066CC',
                    align: 'left',
                    valign: 'middle'
                });
                
                let currentY = 1.3;
                const lineHeight = 0.3;
                
                // Add bullet points
                if (slideInfo.bullets && slideInfo.bullets.length > 0) {
                    for (let i = 0; i < slideInfo.bullets.length; i++) {
                        const bullet = slideInfo.bullets[i];
                        
                        slide.addText(`‚Ä¢ ${bullet}`, {
                            x: 0.8,
                            y: currentY,
                            w: 8.7,
                            h: lineHeight,
                            fontSize: 16,
                            fontFace: 'Segoe UI',
                            color: '4B5563',
                            align: 'left',
                            valign: 'top'
                        });
                        
                        currentY += lineHeight + 0.05;
                    }
                }
            }
            
            // Add presenter notes if available
            if (slideInfo.presenterNotes) {
                slide.addNotes(slideInfo.presenterNotes);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Initialize log
        log('PptxGenJS test page loaded');
        log(`PptxGenJS available: ${typeof PptxGenJS !== 'undefined'}`);
    </script>
</body>
</html>
